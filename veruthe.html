<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerala State Syllabus - Learn Smarter</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a092d;
            background-image: radial-gradient(circle at 25% 15%, rgba(67, 56, 202, 0.4) 0%, rgba(67, 56, 202, 0) 50%),
                              radial-gradient(circle at 75% 85%, rgba(219, 39, 119, 0.3) 0%, rgba(219, 39, 119, 0) 50%);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        
        .btn-premium {
            background-image: linear-gradient(to right, #4f46e5, #c026d3);
        }

        .btn-premium:hover {
            background-image: linear-gradient(to right, #c026d3, #4f46e5);
        }

        .gradient-text {
            background-image: linear-gradient(to right, #818cf8, #f472b6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* For custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0a092d;
        }
        ::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #c026d3;
        }
    </style>
</head>
<body class="text-gray-200 antialiased">
    <div id="app">
        <!-- App content will be rendered here by JavaScript -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            collection,
            addDoc,
            query,
            where,
            getDocs,
            onSnapshot,
            serverTimestamp,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIG & INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
          apiKey: "AIzaSyB4EctByPJY37D9u4XPSG2v2sFcEyCLvUs",
          authDomain: "courses-app-b862e.firebaseapp.com",
          projectId: "courses-app-b862e",
          storageBucket: "courses-app-b862e.appspot.com",
          messagingSenderId: "268387672291",
          appId: "1:268387672291:web:1fd3f2ba238b5a5b0525d6",
          measurementId: "G-ZHGK1904YS"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('app').innerHTML = `<div class="text-center text-red-500 p-8">Error: Could not connect to services.</div>`;
        }

        // --- MOCK DATA ---
        const COURSES = {
            'class-8': { id: 'class-8', name: 'Class 8', validityDays: 365, subjects: {
                'physics': { name: 'Physics', videos: [ {title: 'Force and Pressure', id: 'ky95S-eRwa4'}, {title: 'Friction', id: 'eM7z_43Hn0M'} ] },
                'chemistry': { name: 'Chemistry', videos: [ {title: 'Synthetic Fibres and Plastics', id: '1uGa5unVasA'}, {title: 'Materials: Metals and Non-Metals', id: 'a12nAmtgYvg'} ] },
                'biology': { name: 'Biology', videos: [ {title: 'Cell - Structure and Functions', id: 'py_vS8Y3g7Y'}, {title: 'Microorganisms: Friend and Foe', id: 'H6Y8_s-pGt4'} ] },
                'mathematics': { name: 'Mathematics', videos: [ {title: 'Rational Numbers', id: 'MyL00vS_C1o'}, {title: 'Linear Equations in One Variable', id: 'fukn_g2iM-U'} ] },
            }},
            'class-9': { id: 'class-9', name: 'Class 9', validityDays: 365, subjects: {
                 'physics': { name: 'Physics', videos: [ {title: 'Motion', id: '4CYsKjVg-Gk'}, {title: 'Force and Laws of Motion', id: 'TUgP-eDH9QbU'} ] },
                'chemistry': { name: 'Chemistry', videos: [ {title: 'Matter in Our Surroundings', id: 'jbring2X_4w'}, {title: 'Is Matter Around Us Pure', id: 'cnk-i5Of328'} ] },
                'biology': { name: 'Biology', videos: [ {title: 'The Fundamental Unit of Life', id: 'PMr842G-pUA'}, {title: 'Tissues', id: 'TCqSkd7dM8I'} ] },
                'mathematics': { name: 'Mathematics', videos: [ {title: 'Number Systems', id: 'B-ynQ_w-fI8'}, {title: 'Polynomials', id: 'K3FpY4-Q-OQ'} ] },
            }},
            'class-10': { id: 'class-10', name: 'Class 10', validityDays: 365, subjects: {
                'physics': { name: 'Physics', videos: [ {title: 'Light - Reflection and Refraction', id: 'oG-b-a1G4pE'}, {title: 'The Human Eye and The Colourful World', id: 'SiQoV-aZ3bQ'} ] },
                'chemistry': { name: 'Chemistry', videos: [ {title: 'Chemical Reactions and Equations', id: 's9pB3Ybcc5c'}, {title: 'Acids, Bases and Salts', id: 'iiCr2a_e-oY'} ] },
                'biology': { name: 'Biology', videos: [ {title: 'Life Processes', id: 'vG_N60j6aEg'}, {title: 'Control and Coordination', id: 'yoSFY892Aew'} ] },
                'mathematics': { name: 'Mathematics', videos: [ {title: 'Real Numbers', id: 'O6vQJT1FzPs'}, {title: 'Polynomials', id: 'E-aM6Lqpr_A'} ] },
            }},
        };

        // --- STATE MANAGEMENT ---
        const state = {
            currentUser: null,
            userData: null,
            enrollments: {}, // { 'class-8': { expiryDate, ... } }
            currentCourse: null,
            currentSubject: null,
            admin: {
                users: [],
                payments: [],
            },
            listeners: [], // To manage Firestore listeners
        };
        
        // --- ROUTER ---
        function navigate(path) {
            window.location.hash = path;
        }

        async function router() {
            const path = window.location.hash.slice(1) || '/';
            const [mainPath, subPath] = path.split('/').filter(p => p);

            const appContainer = document.getElementById('app');
            appContainer.innerHTML = ''; // Clear previous content

            renderNavbar();

            switch (mainPath) {
                case 'login':
                    appContainer.insertAdjacentHTML('beforeend', LoginPage());
                    attachLoginHandlers();
                    break;
                case 'signup':
                    appContainer.insertAdjacentHTML('beforeend', SignupPage());
                    attachSignupHandlers();
                    break;
                case 'courses':
                    if (subPath && COURSES[subPath]) {
                        await renderCourseDetail(subPath);
                    } else {
                        appContainer.insertAdjacentHTML('beforeend', CoursesPage());
                    }
                    break;
                case 'payment':
                    if (subPath && COURSES[subPath]) {
                        appContainer.insertAdjacentHTML('beforeend', PaymentPage(COURSES[subPath]));
                        attachPaymentHandlers(subPath);
                    } else {
                        navigate('/courses');
                    }
                    break;
                case 'admin':
                    if (state.userData?.role === 'admin') {
                         appContainer.insertAdjacentHTML('beforeend', await AdminDashboardPage());
                         attachAdminHandlers();
                    } else {
                         appContainer.insertAdjacentHTML('beforeend', HomePage());
                    }
                    break;
                default:
                    appContainer.insertAdjacentHTML('beforeend', HomePage());
            }
            
            feather.replace(); // To render icons
        }
        
        // --- UI COMPONENTS / PAGES ---
        const Navbar = () => {
            const { currentUser, userData } = state;
            return `
                <nav class="bg-gray-900/30 backdrop-blur-lg sticky top-0 z-50 border-b border-white/10">
                    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                        <a href="#/" class="text-2xl font-bold gradient-text">EduKerala</a>
                        <div class="hidden md:flex items-center space-x-8">
                            <a href="#/" class="hover:text-pink-400 transition">Home</a>
                            <a href="#/courses" class="hover:text-pink-400 transition">Courses</a>
                             ${userData?.role === 'admin' ? `<a href="#/admin" class="hover:text-pink-400 transition">Admin</a>` : ''}
                        </div>
                        <div class="flex items-center space-x-4">
                            ${currentUser ? `
                                <span class="hidden sm:block">Welcome, ${userData?.name || ''}</span>
                                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">Logout</button>
                            ` : `
                                <a href="#/login" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">Login</a>
                                <a href="#/signup" class="btn-premium text-white font-bold py-2 px-4 rounded-lg transition hidden sm:block">Sign Up</a>
                            `}
                        </div>
                    </div>
                </nav>
            `;
        }

        const HomePage = () => `
            <div class="container mx-auto px-6 py-24 text-center">
                <h1 class="text-4xl md:text-6xl font-extrabold leading-tight mb-4">
                    <span class="gradient-text">Kerala State Classes 8, 9 & 10</span>
                </h1>
                <p class="text-xl text-gray-400 mb-8 max-w-3xl mx-auto">
                    Learn Smarter, Anytime. High-quality video lessons curated for the Kerala State Syllabus.
                </p>
                <div class="flex justify-center space-x-4">
                    <a href="#/courses" class="btn-premium text-white font-bold py-3 px-8 rounded-lg transition transform hover:scale-105">Explore Courses</a>
                </div>
            </div>
             <div class="container mx-auto px-6 py-16">
                 ${CoursesPage()}
            </div>
        `;
        
        const LoginPage = () => `
            <div class="flex items-center justify-center py-12 px-4">
                <div class="w-full max-w-md space-y-8 glass-card p-8">
                    <div>
                        <h2 class="mt-6 text-center text-3xl font-extrabold gradient-text">Log in to your account</h2>
                    </div>
                    <form id="login-form" class="mt-8 space-y-6">
                        <div class="rounded-md shadow-sm -space-y-px">
                            <div>
                                <input id="login-email" name="email" type="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm rounded-t-md" placeholder="Email address">
                            </div>
                            <div>
                                <input id="login-password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm rounded-b-md" placeholder="Password">
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                             <a href="#" id="forgot-password-link" class="text-sm text-indigo-400 hover:text-indigo-300">Forgot your password?</a>
                        </div>
                        <div>
                            <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white btn-premium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                                Login
                            </button>
                        </div>
                         <p id="login-error" class="text-red-500 text-sm mt-2 text-center"></p>
                         <p class="text-center text-sm">Don't have an account? <a href="#/signup" class="font-medium text-indigo-400 hover:text-indigo-300">Sign up</a></p>
                    </form>
                </div>
            </div>
        `;
        
        const SignupPage = () => `
             <div class="flex items-center justify-center py-12 px-4">
                <div class="w-full max-w-md space-y-8 glass-card p-8">
                    <div>
                        <h2 class="mt-6 text-center text-3xl font-extrabold gradient-text">Create a new account</h2>
                    </div>
                    <form id="signup-form" class="mt-8 space-y-6">
                        <div class="rounded-md shadow-sm space-y-4">
                             <div>
                                <input id="signup-name" name="name" type="text" required class="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Full Name">
                            </div>
                            <div>
                                <input id="signup-email" name="email" type="email" required class="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Email address">
                            </div>
                            <div>
                                <input id="signup-password" name="password" type="password" required class="appearance-none rounded-md relative block w-full px-3 py-3 border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Password">
                            </div>
                        </div>
                        <div>
                            <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white btn-premium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                                Sign Up
                            </button>
                        </div>
                        <p id="signup-error" class="text-red-500 text-sm mt-2 text-center"></p>
                        <p class="text-center text-sm">Already have an account? <a href="#/login" class="font-medium text-indigo-400 hover:text-indigo-300">Log in</a></p>
                    </form>
                </div>
            </div>
        `;
        
        const CoursesPage = () => {
            let courseCards = '';
            for (const courseId in COURSES) {
                const course = COURSES[courseId];
                const enrollment = state.enrollments[courseId];
                const isEnrolled = enrollment && enrollment.expiryDate && new Date(enrollment.expiryDate.toDate()) > new Date();
                
                courseCards += `
                    <a href="#/courses/${course.id}" class="block glass-card p-6 overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-2xl hover:shadow-indigo-500/20">
                        <div class="flex justify-between items-start">
                             <h3 class="text-2xl font-bold text-white mb-2">${course.name}</h3>
                             ${isEnrolled ? `<div class="flex items-center text-green-400 bg-green-500/10 px-3 py-1 rounded-full text-sm font-semibold"><i data-feather="unlock" class="w-4 h-4 mr-2"></i>Unlocked</div>`
                                          : `<div class="flex items-center text-amber-400 bg-amber-500/10 px-3 py-1 rounded-full text-sm font-semibold"><i data-feather="lock" class="w-4 h-4 mr-2"></i>Locked</div>`
                             }
                        </div>
                        <p class="text-gray-400 mb-4">Comprehensive video lessons for all subjects.</p>
                        ${isEnrolled ? `<div class="text-sm text-gray-300">Expires in: ${getDaysLeft(enrollment.expiryDate.toDate())} days</div>` : `<div class="text-sm text-indigo-400 font-semibold">Click to enroll</div>`}
                    </a>
                `;
            }

            return `
                <div class="container mx-auto px-6 py-16">
                    <h2 class="text-3xl md:text-4xl font-bold text-center mb-12 gradient-text">Our Courses</h2>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                        ${courseCards}
                    </div>
                </div>
            `;
        };

        const CourseDetailPage = (course, enrollment) => {
            const isEnrolled = enrollment && enrollment.expiryDate && new Date(enrollment.expiryDate.toDate()) > new Date();
            const daysLeft = isEnrolled ? getDaysLeft(enrollment.expiryDate.toDate()) : 0;
            
            let subjectHtml = '';
            for(const subjectId in course.subjects) {
                const subject = course.subjects[subjectId];
                let videoListHtml = '';
                if(isEnrolled) {
                     videoListHtml = subject.videos.map(video => `
                        <div class="flex items-center space-x-4 p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition cursor-pointer video-item" data-video-id="${video.id}">
                            <i data-feather="play-circle" class="w-8 h-8 text-indigo-400"></i>
                            <span class="text-white">${video.title}</span>
                        </div>
                     `).join('');
                } else {
                     videoListHtml = subject.videos.map(video => `
                        <div class="flex items-center space-x-4 p-4 bg-gray-800/50 rounded-lg opacity-50">
                            <i data-feather="lock" class="w-8 h-8 text-gray-500"></i>
                            <span class="text-gray-400">${video.title}</span>
                        </div>
                     `).join('');
                }
               
                subjectHtml += `
                    <div class="glass-card p-6">
                        <h4 class="text-2xl font-semibold mb-4 text-pink-400">${subject.name}</h4>
                        <div class="space-y-3">
                            ${videoListHtml}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="container mx-auto px-4 py-12">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h2 class="text-4xl font-bold gradient-text">${course.name}</h2>
                            <p class="text-gray-400">Select a subject to view video lessons.</p>
                        </div>
                        ${isEnrolled ? `
                            <div class="glass-card p-4 mt-4 md:mt-0 text-center">
                                <div class="text-3xl font-bold text-green-400">${daysLeft}</div>
                                <div class="text-sm text-gray-300">Days Left</div>
                            </div>
                        ` : `
                            <a href="#/payment/${course.id}" class="mt-4 md:mt-0 btn-premium text-white font-bold py-3 px-6 rounded-lg transition transform hover:scale-105">
                                Buy Course Now
                            </a>
                        `}
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-8 mb-8">
                        <!-- Video player will go here -->
                        <div id="video-player-container" class="glass-card p-4 md:col-span-2 rounded-lg aspect-video ${isEnrolled ? '' : 'hidden'}">
                             <p class="flex items-center justify-center h-full text-gray-400">
                                <i data-feather="film" class="w-10 h-10 mr-4"></i>
                                Select a video to start watching
                            </p>
                        </div>
                    </div>
                    
                    <div class="grid lg:grid-cols-2 gap-8">
                        ${subjectHtml}
                    </div>
                </div>
            `;
        }

        const PaymentPage = (course) => `
            <div class="container mx-auto px-4 py-16">
                 <h2 class="text-3xl md:text-4xl font-bold text-center mb-4 gradient-text">Enroll in ${course.name}</h2>
                 <p class="text-center text-gray-400 max-w-2xl mx-auto mb-12">Complete the payment and submit the details below to get access.</p>
                 <div class="grid md:grid-cols-2 gap-12 items-center">
                    <div class="glass-card p-8 text-center">
                        <h3 class="text-2xl font-semibold mb-4">Scan to Pay with UPI</h3>
                        <p class="text-gray-400 mb-4">Use any UPI app like GPay, PhonePe, or Paytm.</p>
                        <!-- Placeholder for QR Code Image -->
                        <img src="https://placehold.co/300x300/111827/FFFFFF?text=Scan+QR+Code" alt="UPI QR Code" class="mx-auto rounded-lg shadow-lg">
                        <p class="mt-4 text-lg font-bold">UPI ID: your-upi-id@okhdfcbank</p>
                    </div>
                    <div class="glass-card p-8">
                        <h3 class="text-2xl font-semibold mb-6">Submit Payment Details</h3>
                        <form id="payment-form" class="space-y-6">
                             <div>
                                <label for="transactionId" class="block text-sm font-medium text-gray-300 mb-2">Transaction ID / UTR</label>
                                <input type="text" id="transactionId" required class="w-full px-3 py-3 border border-gray-700 bg-gray-800 text-white placeholder-gray-500 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                             <!-- Screenshot upload is complex without storage; focusing on transaction ID -->
                             <p class="text-xs text-gray-500">Your access will be manually approved by an admin within 24 hours after verification.</p>
                             <div>
                                <button type="submit" class="w-full btn-premium text-white font-bold py-3 px-6 rounded-lg transition transform hover:scale-105">
                                    Submit for Verification
                                </button>
                            </div>
                            <p id="payment-message" class="text-center mt-4"></p>
                        </form>
                    </div>
                 </div>
            </div>
        `;
        
        const AdminDashboardPage = async () => {
            const { users, payments } = state.admin;
            return `
                <div class="container mx-auto px-4 py-12">
                    <h2 class="text-4xl font-bold gradient-text mb-8">Admin Dashboard</h2>
                    
                    <!-- Pending Payments Section -->
                    <div class="mb-12">
                        <h3 class="text-2xl font-semibold mb-4 text-pink-400">Pending Payments</h3>
                        <div class="glass-card overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="bg-gray-800/50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">User Email</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Course</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Transaction ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-700">
                                        ${payments.length > 0 ? payments.map(p => `
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">${p.userEmail}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">${COURSES[p.courseId]?.name || p.courseId}</td>
                                                <td class="px-6 py-4 whitespace-nowrap font-mono text-sm">${p.transactionId}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">${p.submittedAt.toDate().toLocaleString()}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-right">
                                                    <button data-payment-id="${p.id}" data-user-id="${p.userId}" data-course-id="${p.courseId}" class="approve-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">Approve</button>
                                                </td>
                                            </tr>
                                        `).join('') : `<tr><td colspan="5" class="text-center py-8 text-gray-400">No pending payments.</td></tr>`}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- All Users Section -->
                    <div>
                        <h3 class="text-2xl font-semibold mb-4 text-pink-400">All Users</h3>
                        <div class="glass-card overflow-hidden">
                           <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="bg-gray-800/50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Email</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Role</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-700">
                                        ${users.map(u => `
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap">${u.name}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">${u.email}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">${u.role}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- RENDER & EVENT HANDLERS ---
        function renderNavbar() {
            const navContainer = document.createElement('div');
            navContainer.innerHTML = Navbar();
            document.getElementById('app').prepend(navContainer);
            if(state.currentUser) {
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
            }
        }
        
        async function renderCourseDetail(courseId) {
            const appContainer = document.getElementById('app');
            const course = COURSES[courseId];
            if (!course) {
                navigate('/courses');
                return;
            }
            const enrollment = state.enrollments[courseId];
            appContainer.insertAdjacentHTML('beforeend', CourseDetailPage(course, enrollment));
            
            // Attach video player handlers
            document.querySelectorAll('.video-item').forEach(item => {
                item.addEventListener('click', () => {
                    const videoId = item.dataset.videoId;
                    const playerContainer = document.getElementById('video-player-container');
                    playerContainer.innerHTML = `
                        <iframe class="w-full h-full rounded-lg" src="https://www.youtube.com/embed/${videoId}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    `;
                });
            });
        }
        
        function attachLoginHandlers() {
            const form = document.getElementById('login-form');
            form?.addEventListener('submit', handleLogin);
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            forgotPasswordLink?.addEventListener('click', handlePasswordReset);
        }
        
        function attachSignupHandlers() {
            const form = document.getElementById('signup-form');
            form?.addEventListener('submit', handleSignup);
        }

        function attachPaymentHandlers(courseId) {
            const form = document.getElementById('payment-form');
            form?.addEventListener('submit', (e) => handlePaymentSubmit(e, courseId));
        }
        
        function attachAdminHandlers() {
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { paymentId, userId, courseId } = e.target.dataset;
                    handleApprovePayment(paymentId, userId, courseId);
                    e.target.textContent = 'Approved';
                    e.target.disabled = true;
                    e.target.classList.remove('bg-green-600', 'hover:bg-green-700');
                    e.target.classList.add('bg-gray-500', 'cursor-not-allowed');
                });
            });
        }
        
        // --- AUTHENTICATION LOGIC ---
        
        async function handleSignup(e) {
            e.preventDefault();
            const name = e.target.elements['signup-name'].value;
            const email = e.target.elements['signup-email'].value;
            const password = e.target.elements['signup-password'].value;
            const errorEl = document.getElementById('signup-error');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                // Create user document in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    name: name,
                    email: email,
                    role: 'student', // default role
                    createdAt: serverTimestamp()
                });
                navigate('/');
            } catch (error) {
                errorEl.textContent = error.message;
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target.elements['login-email'].value;
            const password = e.target.elements['login-password'].value;
            const errorEl = document.getElementById('login-error');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                navigate('/');
            } catch (error) {
                errorEl.textContent = "Invalid email or password.";
            }
        }
        
        async function handleLogout() {
            await signOut(auth);
            navigate('/login');
        }

        async function handlePasswordReset(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            if (!email) {
                alert("Please enter your email address to reset your password.");
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                alert("Password reset email sent! Check your inbox.");
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        // --- FIRESTORE & APP LOGIC ---

        async function onAuthChange(user) {
            // Unsubscribe from old listeners
            state.listeners.forEach(unsub => unsub());
            state.listeners = [];

            if (user) {
                state.currentUser = user;
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    state.userData = userDocSnap.data();
                } else {
                    // This can happen if a user is created in Auth but the Firestore doc creation fails.
                    state.currentUser = null;
                    state.userData = null;
                    router();
                    return;
                }
                
                // Immediately render the UI with the user's main data.
                // This updates the navbar to the "logged in" state right away.
                router();

                // Admin specific listeners
                if (state.userData?.role === 'admin') {
                   await fetchAdminData();
                }

                // Now, set up a listener for enrollments. When enrollment data arrives
                // or changes, it will trigger another re-render to update course statuses.
                const enrollmentsRef = collection(db, 'enrollments');
                const q = query(enrollmentsRef, where("userId", "==", user.uid));
                const unsubEnrollments = onSnapshot(q, (snapshot) => {
                    state.enrollments = {};
                    snapshot.forEach(doc => {
                        state.enrollments[doc.data().courseId] = { id: doc.id, ...doc.data() };
                    });
                    router(); // Re-render to update UI with new enrollment data
                });
                state.listeners.push(unsubEnrollments);

            } else {
                state.currentUser = null;
                state.userData = null;
                state.enrollments = {};
                router();
            }
        }
        
        async function fetchAdminData() {
             // Listen for pending payments
            const paymentsRef = collection(db, 'payments');
            const pq = query(paymentsRef, where("status", "==", "pending"));
            const unsubPayments = onSnapshot(pq, async (snapshot) => {
                const payments = [];
                for(const docSnapshot of snapshot.docs) {
                    const paymentData = docSnapshot.data();
                    const userSnap = await getDoc(doc(db, 'users', paymentData.userId));
                    payments.push({ id: docSnapshot.id, ...paymentData, userEmail: userSnap.exists() ? userSnap.data().email : 'N/A' });
                }
                state.admin.payments = payments;
                 if(window.location.hash.startsWith('#/admin')) router();
            });

            // Get all users
            const usersRef = collection(db, 'users');
            const userDocs = await getDocs(usersRef);
            state.admin.users = userDocs.docs.map(doc => ({id: doc.id, ...doc.data()}));
            
            state.listeners.push(unsubPayments);
            if(window.location.hash.startsWith('#/admin')) router();
        }

        async function handlePaymentSubmit(e, courseId) {
            e.preventDefault();
            if (!state.currentUser) {
                navigate('/login');
                return;
            }
            const transactionId = e.target.elements.transactionId.value;
            const messageEl = document.getElementById('payment-message');
            
            try {
                await addDoc(collection(db, "payments"), {
                    userId: state.currentUser.uid,
                    courseId: courseId,
                    transactionId: transactionId,
                    status: 'pending', // 'pending', 'approved', 'rejected'
                    submittedAt: serverTimestamp()
                });
                messageEl.textContent = "Submission successful! We will review it shortly.";
                messageEl.className = 'text-green-500 text-center mt-4';
                e.target.reset();
            } catch (error) {
                messageEl.textContent = `Error: ${error.message}`;
                messageEl.className = 'text-red-500 text-center mt-4';
            }
        }

        async function handleApprovePayment(paymentId, userId, courseId) {
            const paymentRef = doc(db, 'payments', paymentId);
            const course = COURSES[courseId];
            if(!course) {
                console.error("Invalid course ID on payment approval:", courseId);
                return;
            }

            try {
                // 1. Update payment status
                await updateDoc(paymentRef, { status: 'approved' });
                
                // 2. Create enrollment
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + course.validityDays);

                await addDoc(collection(db, 'enrollments'), {
                    userId,
                    courseId,
                    purchaseDate: new Date(),
                    expiryDate,
                    status: 'active'
                });

                console.log(`Payment ${paymentId} approved for user ${userId}`);

            } catch (error) {
                console.error("Error approving payment: ", error);
            }
        }

        // --- UTILS ---
        function getDaysLeft(expiry) {
            const today = new Date();
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        }

        // --- APP START ---
        window.addEventListener('hashchange', router);

        // This function is called whenever the auth state changes.
        onAuthStateChanged(auth, (user) => {
            onAuthChange(user);
        });

        // This function runs once on initial load to establish a session.
        async function initializeSession() {
            // We only try to auto-sign-in if there's no user logged in currently.
            if (!auth.currentUser) {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        // This is the call that can fail if Anonymous sign-in isn't enabled.
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error(
                        "Could not automatically sign in. If you see 'auth/admin-restricted-operation', please enable 'Anonymous' sign-in in your Firebase project's Authentication settings.",
                        error
                    );
                    // Even if auto sign-in fails, the onAuthStateChanged listener is already active
                    // and will have been called with `user=null`, so the UI will render correctly.
                    onAuthChange(null);
                }
            }
        }

        // Kick things off.
        initializeSession();

    </script>
</body>
</html>